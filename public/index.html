<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üçΩÔ∏è Table Reservation System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #fff;
    }
    
    .header {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      text-align: center;
      backdrop-filter: blur(10px);
    }
    
    .header h1 {
      font-size: 2rem;
      margin-bottom: 5px;
    }
    
    .header p {
      opacity: 0.7;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: 20px;
    }
    
    .panel {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .panel h2 {
      font-size: 1.2rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Floor Plan */
    .floor-plan {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      padding: 20px;
    }
    
    .table {
      aspect-ratio: 1;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .table:hover {
      transform: scale(1.05);
    }
    
    .table.available {
      background: linear-gradient(135deg, #00b894, #00cec9);
    }
    
    .table.occupied {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }
    
    .table.reserved {
      background: linear-gradient(135deg, #f39c12, #e67e22);
    }
    
    .table.selected {
      border-color: #fff;
      box-shadow: 0 0 20px rgba(255,255,255,0.5);
    }
    
    .table-number {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .table-capacity {
      font-size: 0.8rem;
      opacity: 0.8;
    }
    
    .table-status {
      font-size: 0.7rem;
      margin-top: 5px;
      text-transform: uppercase;
    }
    
    /* Forms */
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 1rem;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #00b894;
    }
    
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #00b894, #00cec9);
      color: #fff;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,184,148,0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: #fff;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
    }
    
    /* Reservations List */
    .reservation-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .reservation-item {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 4px solid #00b894;
    }
    
    .reservation-item.walk-in {
      border-left-color: #f39c12;
    }
    
    .reservation-item.seated {
      border-left-color: #3498db;
    }
    
    .reservation-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .reservation-details {
      font-size: 0.85rem;
      opacity: 0.7;
    }
    
    .reservation-actions {
      margin-top: 8px;
      display: flex;
      gap: 5px;
    }
    
    .reservation-actions button {
      padding: 5px 10px;
      font-size: 0.75rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    
    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .stat {
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
    }
    
    .stat-label {
      font-size: 0.75rem;
      opacity: 0.7;
    }
    
    .stat.available .stat-value { color: #00b894; }
    .stat.occupied .stat-value { color: #e74c3c; }
    .stat.reserved .stat-value { color: #f39c12; }
    .stat.walkins .stat-value { color: #3498db; }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: #fff;
      font-weight: bold;
      animation: slideIn 0.3s ease;
      z-index: 1000;
    }
    
    .toast.success { background: #00b894; }
    .toast.error { background: #e74c3c; }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }
    
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }
    
    .legend-color.available { background: #00b894; }
    .legend-color.occupied { background: #e74c3c; }
    .legend-color.reserved { background: #f39c12; }
    
    /* Clock */
    .clock {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üçΩÔ∏è Table Reservation System</h1>
    <p>Restaurant Floor Management</p>
  </div>
  
  <div class="container">
    <!-- Left Panel: New Reservation / Walk-in -->
    <div class="panel">
      <h2>üìù New Reservation</h2>
      
      <form id="reservationForm">
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="customerName" placeholder="Enter name" required>
        </div>
        
        <div class="form-group">
          <label>Party Size</label>
          <select id="partySize">
            <option value="1">1 person</option>
            <option value="2" selected>2 people</option>
            <option value="3">3 people</option>
            <option value="4">4 people</option>
            <option value="5">5 people</option>
            <option value="6">6 people</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Date & Time</label>
          <input type="datetime-local" id="startTime" required>
        </div>
        
        <div class="form-group">
          <label>Phone (optional)</label>
          <input type="tel" id="customerPhone" placeholder="555-1234">
        </div>
        
        <button type="submit" class="btn btn-primary">Create Reservation</button>
      </form>
      
      <hr style="border-color: rgba(255,255,255,0.1); margin: 20px 0;">
      
      <h2>üö∂ Walk-in Guest</h2>
      
      <form id="walkInForm">
        <div class="form-group">
          <label>Guest Name</label>
          <input type="text" id="walkInName" placeholder="Enter name" required>
        </div>
        
        <div class="form-group">
          <label>Party Size</label>
          <select id="walkInSize">
            <option value="1">1 person</option>
            <option value="2" selected>2 people</option>
            <option value="3">3 people</option>
            <option value="4">4 people</option>
            <option value="5">5 people</option>
            <option value="6">6 people</option>
          </select>
        </div>
        
        <button type="submit" class="btn btn-secondary">Seat Walk-in Now</button>
      </form>
    </div>
    
    <!-- Center Panel: Floor Plan -->
    <div class="panel">
      <h2>üó∫Ô∏è Floor Plan</h2>
      
      <div class="stats">
        <div class="stat available">
          <div class="stat-value" id="availableCount">-</div>
          <div class="stat-label">Available</div>
        </div>
        <div class="stat occupied">
          <div class="stat-value" id="occupiedCount">-</div>
          <div class="stat-label">Occupied</div>
        </div>
        <div class="stat reserved">
          <div class="stat-value" id="reservedCount">-</div>
          <div class="stat-label">Reserved</div>
        </div>
        <div class="stat walkins">
          <div class="stat-value" id="walkInCount">-</div>
          <div class="stat-label">Walk-ins Today</div>
        </div>
      </div>
      
      <div class="floor-plan" id="floorPlan">
        <!-- Tables will be rendered here -->
      </div>
      
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color available"></div>
          <span>Available</span>
        </div>
        <div class="legend-item">
          <div class="legend-color reserved"></div>
          <span>Reserved</span>
        </div>
        <div class="legend-item">
          <div class="legend-color occupied"></div>
          <span>Occupied</span>
        </div>
      </div>
    </div>
    
    <!-- Right Panel: Current Reservations -->
    <div class="panel">
      <div class="clock" id="clock">--:--:--</div>
      
      <h2>üìã Today's Reservations</h2>
      
      <div class="reservation-list" id="reservationList">
        <!-- Reservations will be rendered here -->
      </div>
    </div>
  </div>
  
  <script>
    const API_BASE = '/api/v1';
    
    // Update clock
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString();
    }
    setInterval(updateClock, 1000);
    updateClock();
    
    // Set default datetime to 1 hour from now
    const defaultTime = new Date(Date.now() + 3600000);
    document.getElementById('startTime').value = defaultTime.toISOString().slice(0, 16);
    
    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    // Fetch and render tables
    async function loadTables() {
      try {
        const res = await fetch(`${API_BASE}/tables`);
        const data = await res.json();
        
        if (data.success) {
          renderTables(data.data);
          updateStats(data.data);
        }
      } catch (error) {
        console.error('Failed to load tables:', error);
      }
    }
    
    function renderTables(tables) {
      const floorPlan = document.getElementById('floorPlan');
      floorPlan.innerHTML = tables.map(table => `
        <div class="table ${table.status.toLowerCase()}" 
             data-id="${table.id}" 
             data-capacity="${table.capacity}"
             onclick="selectTable('${table.id}')">
          <div class="table-number">${table.number}</div>
          <div class="table-capacity">üë• ${table.capacity}</div>
          <div class="table-status">${table.status}</div>
        </div>
      `).join('');
    }
    
    function updateStats(tables) {
      const available = tables.filter(t => t.status === 'AVAILABLE').length;
      const occupied = tables.filter(t => t.status === 'OCCUPIED').length;
      const reserved = tables.filter(t => t.status === 'RESERVED').length;
      
      document.getElementById('availableCount').textContent = available;
      document.getElementById('occupiedCount').textContent = occupied;
      document.getElementById('reservedCount').textContent = reserved;
    }
    
    // Fetch walk-in stats
    async function loadWalkInStats() {
      try {
        const res = await fetch(`${API_BASE}/walk-ins/stats`);
        const data = await res.json();
        
        if (data.success) {
          document.getElementById('walkInCount').textContent = data.data.total;
        }
      } catch (error) {
        console.error('Failed to load walk-in stats:', error);
      }
    }
    
    // Fetch and render reservations
    async function loadReservations() {
      try {
        const res = await fetch(`${API_BASE}/reservations/today`);
        const data = await res.json();
        
        if (data.success) {
          renderReservations(data.data);
        }
      } catch (error) {
        console.error('Failed to load reservations:', error);
      }
    }
    
    function renderReservations(reservations) {
      const list = document.getElementById('reservationList');
      
      if (reservations.length === 0) {
        list.innerHTML = '<p style="opacity: 0.5; text-align: center;">No reservations today</p>';
        return;
      }
      
      list.innerHTML = reservations.map(r => `
        <div class="reservation-item ${r.isWalkIn ? 'walk-in' : ''} ${r.status.toLowerCase()}">
          <div class="reservation-name">
            ${r.isWalkIn ? 'üö∂' : 'üìÖ'} ${r.customerName}
          </div>
          <div class="reservation-details">
            üë• ${r.partySize} people ¬∑ üïê ${new Date(r.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
            <br>
            Status: <strong>${r.status}</strong>
          </div>
          <div class="reservation-actions">
            ${r.status === 'CONFIRMED' ? `
              <button onclick="seatGuest('${r.id}', ${r.version})" style="background: #3498db; color: white;">
                Seat Guest
              </button>
            ` : ''}
            ${r.status === 'SEATED' ? `
              <button onclick="completeReservation('${r.id}', ${r.version})" style="background: #00b894; color: white;">
                Complete
              </button>
            ` : ''}
            ${['CONFIRMED', 'PENDING'].includes(r.status) ? `
              <button onclick="cancelReservation('${r.id}', ${r.version})" style="background: #e74c3c; color: white;">
                Cancel
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }
    
    // Select table
    let selectedTableId = null;
    function selectTable(tableId) {
      document.querySelectorAll('.table').forEach(t => t.classList.remove('selected'));
      document.querySelector(`[data-id="${tableId}"]`)?.classList.add('selected');
      selectedTableId = tableId;
    }
    
    // Create reservation
    document.getElementById('reservationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const startTimeInput = document.getElementById('startTime').value;
      const startTime = new Date(startTimeInput).toISOString();
      
      const payload = {
        customerName: document.getElementById('customerName').value,
        partySize: parseInt(document.getElementById('partySize').value),
        startTime: startTime,
        customerPhone: document.getElementById('customerPhone').value || undefined,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      };
      
      if (selectedTableId) {
        payload.preferredTableId = selectedTableId;
      }
      
      try {
        const res = await fetch(`${API_BASE}/reservations`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('Reservation created!');
          document.getElementById('reservationForm').reset();
          document.getElementById('startTime').value = new Date(Date.now() + 3600000).toISOString().slice(0, 16);
          selectedTableId = null;
          refresh();
        } else {
          showToast(data.error?.message || 'Failed to create reservation', 'error');
        }
      } catch (error) {
        showToast('Error creating reservation', 'error');
      }
    });
    
    // Handle walk-in
    document.getElementById('walkInForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const payload = {
        customerName: document.getElementById('walkInName').value,
        partySize: parseInt(document.getElementById('walkInSize').value)
      };
      
      try {
        const res = await fetch(`${API_BASE}/walk-ins`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast(`Walk-in seated at Table ${data.data.table.number}!`);
          document.getElementById('walkInForm').reset();
          refresh();
        } else {
          showToast(data.error?.message || 'No tables available', 'error');
        }
      } catch (error) {
        showToast('Error processing walk-in', 'error');
      }
    });
    
    // Seat guest
    async function seatGuest(id, version) {
      try {
        const res = await fetch(`${API_BASE}/reservations/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'SEATED', version })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('Guest seated!');
          refresh();
        } else {
          showToast(data.error?.message || 'Failed to seat guest', 'error');
        }
      } catch (error) {
        showToast('Error seating guest', 'error');
      }
    }
    
    // Complete reservation
    async function completeReservation(id, version) {
      try {
        const res = await fetch(`${API_BASE}/reservations/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'COMPLETED', version })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('Reservation completed!');
          refresh();
        } else {
          showToast(data.error?.message || 'Failed to complete', 'error');
        }
      } catch (error) {
        showToast('Error completing reservation', 'error');
      }
    }
    
    // Cancel reservation
    async function cancelReservation(id, version) {
      if (!confirm('Are you sure you want to cancel this reservation?')) return;
      
      try {
        const res = await fetch(`${API_BASE}/reservations/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ version })
        });
        
        const data = await res.json();
        
        if (data.success) {
          showToast('Reservation cancelled');
          refresh();
        } else {
          showToast(data.error?.message || 'Failed to cancel', 'error');
        }
      } catch (error) {
        showToast('Error cancelling reservation', 'error');
      }
    }
    
    // Refresh all data
    function refresh() {
      loadTables();
      loadReservations();
      loadWalkInStats();
    }
    
    // Initial load
    refresh();
    
    // Auto-refresh every 5 seconds
    setInterval(refresh, 5000);
  </script>
</body>
</html>
